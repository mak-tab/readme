# Scale Bridge Backend üöõ‚öñÔ∏è

–ë—ç–∫–µ–Ω–¥ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤–µ—Å–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è. –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –Ω–∞ **Python (FastAPI)** –¥–ª—è –∑–∞–º–µ–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ –º–æ–Ω–æ–ª–∏—Ç–∞ –Ω–∞ JavaFX.
–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º (–≤–µ—Å—ã, —à–ª–∞–≥–±–∞—É–º—ã, –∫–∞–º–µ—Ä—ã), –≤–µ–¥–µ—Ç –∂—É—Ä–Ω–∞–ª –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏–π –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç API –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

## üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

* **–Ø–∑—ã–∫:** Python 3.9+
* **–§—Ä–µ–π–º–≤–æ—Ä–∫:** FastAPI (Asynchronous)
* **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** PostgreSQL 15
* **ORM:** SQLAlchemy 2.0 (Async) + Alembic (–º–∏–≥—Ä–∞—Ü–∏–∏)
* **–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:**
* `pyserial-asyncio` ‚Äî —á—Ç–µ–Ω–∏–µ –≤–µ—Å–æ–≤—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (CAS/A9).
* `pymodbus` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏ (—à–ª–∞–≥–±–∞—É–º—ã/—Å–≤–µ—Ç–æ—Ñ–æ—Ä—ã).


* **Deploy:** Docker + Docker Compose.

---

## üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

### 1. –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (Docker)

–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –ø–æ–¥–Ω—è—Ç—å –≤—Å—ë –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–ë–î + –ë—ç–∫–µ–Ω–¥).

```bash
# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
docker-compose up --build

```

API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: **`http://localhost:8000`**
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (Swagger): **`http://localhost:8000/docs`**

### 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –±–∞–∑–∞ –ø—É—Å—Ç–∞—è. –ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `admin` / `123`, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É (–Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è —Å–µ—Ä–≤–µ—Ä):

```bash
docker-compose exec backend python -m app.db.init_db

```

---

## üîå API Documentation

–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å `/api/v1`.

### üîê 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Auth)

–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º –º–µ—Ç–æ–¥–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫: `Authorization: Bearer <token>`.

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ |
| --- | --- | --- | --- |
| `POST` | `/auth/login` | –ü–æ–ª—É—á–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞ | `username`, `password` (FormData) |

### üë§ 2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (Users)

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
| --- | --- | --- |
| `GET` | `/users/me` | –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. |
| `POST` | `/users/change-password` | –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è. –¢—Ä–µ–±—É–µ—Ç `old_password` –∏ `new_password`. |

---

### ‚öñÔ∏è 3. –ü—Ä–æ—Ü–µ—Å—Å –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è (Weighing Process) ‚Äî **CORE LOGIC**

–≠—Ç–æ "—Å–µ—Ä–¥—Ü–µ" —Å–∏—Å—Ç–µ–º—ã. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å —ç—Ç–∏–º–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è.

#### WebSocket (Real-time –¥–∞–Ω–Ω—ã–µ)

**URL:** `ws://host:port/api/v1/process/ws`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°—Ç—Ä–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–µ—Å–æ–≤–æ–π. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∏ —Å–ª—É—à–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 200–º—Å.

**–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (JSON):**

```json
{
  "scale_status": "ENTERING",  // IDLE, ENTERING, WEIGHING, CONFIRMATION, EXITING
  "truck_number": "01A777AA",
  "current_weight": 24500.0,   // –¢–µ–∫—É—â–∏–π –≤–µ—Å —Å –¥–∞—Ç—á–∏–∫–æ–≤
  "is_stable": true,           // –°—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è –ª–∏ –≤–µ—Å
  "truck_id": 105,             // ID –∞–∫—Ç–∏–≤–Ω–æ–π –º–∞—à–∏–Ω—ã –≤ –ë–î
  "gate_1_open": false
}

```

#### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
| --- | --- | --- |
| `GET` | `/process/state` | –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∞–Ω–∞–ª–æ–≥ WS, –Ω–æ –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞). |
| `POST` | `/process/start` | –†—É—á–Ω–æ–π —Å—Ç–∞—Ä—Ç –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –Ω–µ —Å—á–∏—Ç–∞–ª–∞ –Ω–æ–º–µ—Ä). Body: `{"truck_number": "..."}`. |
| `POST` | `/process/confirm` | **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–µ—Å–∞**. –û–ø–µ—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–í–∑–≤–µ—Å–∏—Ç—å". –ë—ç–∫–µ–Ω–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–µ—Å –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —à–ª–∞–≥–±–∞—É–º. |
| `POST` | `/process/reset` | –ê–≤–∞—Ä–∏–π–Ω—ã–π —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ `IDLE`. |

---

### üöõ 4. –ñ—É—Ä–Ω–∞–ª –º–∞—à–∏–Ω (Trucks)

CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏—Å—Ç–æ—Ä–∏–µ–π –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏–π.

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
| --- | --- | --- |
| `GET` | `/trucks` | –°–ø–∏—Å–æ–∫ –º–∞—à–∏–Ω —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `skip`, `limit`, `finished` (bool). |
| `GET` | `/trucks/{id}` | –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—à–∏–Ω–µ (–≤–∫–ª—é—á–∞—è —Ñ–æ—Ç–æ –∏ —Å–ø–∏—Å–æ–∫ –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏–π). |
| `POST` | `/trucks` | –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤—Ä—É—á–Ω—É—é (–∞–Ω–∞–ª–æ–≥ `/process/start`). |
| `PUT` | `/trucks/{id}` | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–æ—á–Ω—ã–π –Ω–æ–º–µ—Ä). |

---

### üì∑ 5. –ö–∞–º–µ—Ä—ã –∏ –§–∞–π–ª—ã (Integration)

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
| --- | --- | --- |
| `POST` | `/integration/camera/image` | –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ. `Multipart/form-data`. –¢—Ä–µ–±—É–µ—Ç `file` –∏ `action_id` (ID –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è). |

*–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º —Å—Å—ã–ª–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç API (–Ω–∞–ø—Ä–∏–º–µ—Ä `/api/v1/static/weighing/...jpg`).*

---

### ‚öôÔ∏è 6. –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ (Hardware Low-level)

–ü—Ä—è–º–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ "–∂–µ–ª–µ–∑–æ–º" –≤ –æ–±—Ö–æ–¥ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ (–¥–ª—è —Ç–µ—Å—Ç–æ–≤ –∏ —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞).

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
| --- | --- | --- |
| `GET` | `/hardware/scales/current` | –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –≤–µ—Å–∞ (raw value). |
| `GET` | `/hardware/status` | –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –¥–∞—Ç—á–∏–∫–æ–≤ (gates, sensors, connection). |
| `POST` | `/hardware/gates/{id}/{action}` | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–ª–∞–≥–±–∞—É–º–æ–º. `id`: 1/2. `action`: `open`/`close`. |

---

### üìä 7. –û—Ç—á–µ—Ç—ã –∏ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
| --- | --- | --- |
| `GET` | `/reports/export/excel` | –°–∫–∞—á–∞—Ç—å `.xlsx` —Ñ–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ (`date_from`, `date_to`). |
| `GET` | `/reports/summary` | –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∫–æ–ª-–≤–æ –º–∞—à–∏–Ω, –æ–±—â–∏–π –≤–µ—Å) –∑–∞ –ø–µ—Ä–∏–æ–¥. |
| `GET` | `/products` | –°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫). |
| `POST` | `/products` | –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç. |

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env)

–§–∞–π–ª `.env` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.

```ini
# Database
POSTGRES_SERVER=db
POSTGRES_USER=postgres
POSTGRES_PASSWORD=root123
POSTGRES_DB=scaledb

# Hardware (Serial Ports)
# –î–ª—è Linux: /dev/ttyUSB0, –¥–ª—è Windows: COM3
SCALE_PORT_ENTER=/dev/ttyUSB0
SCALE_PORT_EXIT=/dev/ttyUSB1
SCALE_BAUDRATE=9600

# Cameras
CAMERA_IN_IP=192.168.1.63
CAMERA_OUT_IP=192.168.1.66

```

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

* `app/api` ‚Äî –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã (Endpoints).
* `app/core` ‚Äî –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
* `app/crud` ‚Äî –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î.
* `app/models` ‚Äî SQLAlchemy –º–æ–¥–µ–ª–∏ (–¢–∞–±–ª–∏—Ü—ã).
* `app/schemas` ‚Äî Pydantic —Å—Ö–µ–º—ã (DTO –¥–ª—è JSON).
* `app/services` ‚Äî –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:
* `hardware/` ‚Äî –î—Ä–∞–π–≤–µ—Ä—ã –≤–µ—Å–æ–≤ –∏ GPIO.
* `weighing.py` ‚Äî –õ–æ–≥–∏–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ (State Machine).
* `reporting.py` ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel.
