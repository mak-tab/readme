### Всего в бэкенде **23 эндпоинта** (из них **21 HTTP-запрос** и **2 WebSocket соединения**).

---

### 1. Авторизация (Вход в систему)
* **Эндпоинт:** `POST /api/v1/auth/login`
* **Запрос (Content-Type: application/x-www-form-urlencoded):**
```text
username: +998901234567
password: secret_password
```
* **Ответ (JSON):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsIn...",
  "token_type": "bearer"
}
```
* **Краткое объяснение:**
Используется для получения JWT токена. Обрати внимание: формат запроса — **Form Data**, а не JSON (стандарт OAuth2). Поле `username` принимает номер телефона. Полученный `access_token` нужно добавлять в заголовки всех последующих запросов (`Authorization: Bearer <token>`).

---

### 2. Получение данных текущего пользователя
* **Эндпоинт:** `GET /api/v1/users/me`
* **Запрос:**
* **Headers:** `Authorization: Bearer <access_token>`
* **Ответ (JSON):**
```json
{
  "id": 1,
  "phone_number": "+998901234567",
  "is_active": true,
  "is_superuser": true,
  "internal_scale_id": null
}
```
* **Краткое объяснение:**
Возвращает профиль того пользователя, чей токен был передан. Используется фронтендом при загрузке страницы, чтобы понять, кто залогинен, и отобразить имя/права доступа.

---

### 3. Основной WebSocket процесса (Real-time данные)
* **Эндпоинт:** `WS /api/v1/process/ws`
* **Запрос:** Подключение по протоколу WebSocket.
* **Ответ (Поток JSON данных от сервера, каждые 200мс):**
```json
{
  "scale_status": "IDLE",            // IDLE, ENTERING, WEIGHING, CONFIRMATION
  "truck_number": "01A777AA",        // Номер машины (если есть)
  "current_weight": 24500.0,         // Текущий вес с весов
  "is_stable": true,                 // Стабилизировался ли вес
  "truck_id": 105,                   // ID машины в базе (если процесс идет)
  "gate_1_open": false,              // Статус шлагбаума 1
  "gate_2_open": false,              // Статус шлагбаума 2
  "sensors_active": [0, 1, 0]        // Активность датчиков [1, 2, 3]
}
```
* **Краткое объяснение:**
Самый важный канал связи. Через него фронтенд "рисует" интерфейс: показывает текущий вес, меняет цвет светофоров, поднимает шлагбаумы на экране и показывает номер машины. Фронтенд должен только **слушать** этот сокет. Управляющие команды отправляются отдельными HTTP-запросами.

---

### 4. Статус оборудования (Здоровье системы)
* **Эндпоинт:** `GET /api/v1/hardware/status`
* **Запрос:** Нет тела запроса.
* **Ответ (JSON):**
```json
{
  "controller": true,       // Связь с контроллером Modbus
  "gate_1": false,          // Текущий статус шлагбаума 1 (закрыт)
  "gate_2": false,          // Текущий статус шлагбаума 2
  "sensor_1": false,        // Датчик присутствия
  "scale_connection": true  // Связь с весовым терминалом
}
```
* **Краткое объяснение:**
Используется для цветовой индикации статусов (кнопка "Connect" и иконки Sensor/Gate/Camera на правой панели). Если `scale_connection: false`, фронт должен показать предупреждение.

---

### 5. Управление шлагбаумами (Ручное)
* **Эндпоинт:** `POST /api/v1/hardware/gates/{gate_id}/{action}`
* **Параметры пути (Path):**
* `gate_id`: `1` (Вход 1), `2` (Вход 2), `3` (Выход 1), `4` (Выход 2).
* `action`: `open` (открыть) или `close` (закрыть).
* **Запрос:** Нет тела запроса.
* **Ответ (JSON):**
```json
{
  "status": "success",
  "message": "Gate 1 OPEN command sent"
}
```
* **Краткое объяснение:**
Привязывается к кнопкам `ochish` / `yopish` на правой панели. Посылает команду на физический контроллер.

---

### 6. Мгновенное получение веса (Поллинг)
* **Эндпоинт:** `GET /api/v1/hardware/scales/current`
* **Запрос:** Нет тела запроса.
* **Ответ (JSON):**
```json
{
  "weight_in": 25400.0,  // Весы на въезде
  "weight_out": 0.0      // Весы на выезде (если есть)
}
```
* **Краткое объяснение:**
Используется как запасной вариант, если WebSocket отвалился, или для тестирования. Показывает то, что прямо сейчас видят весы.

---

### 7. Ручной запуск взвешивания (Если камера не считала)
* **Эндпоинт:** `POST /api/v1/process/start`
* **Запрос (JSON):**
```json
{
  "truck_number": "01A777AA"
}
```
* **Ответ (JSON):**
```json
{
  "status": "started",
  "truck_id": 106
}
```
* **Краткое объяснение:**
Используется, когда оператор вводит номер вручную в поле "Truck No." и нажимает "Simulate" или "Start". Создает новую активную сессию взвешивания в БД и переводит статус процесса в `ENTERING`.

---

### 8. Подтверждение веса (Фиксация)
* **Эндпоинт:** `POST /api/v1/process/confirm`
* **Запрос (JSON):**
```json
{
  "truck_id": 105,           // ID берется из текущего состояния WebSocket
  "confirmed_weight": 25400.0,
  "truck_number": "01A777AA" // Опционально, если оператор исправил номер в последний момент
}
```
* **Ответ (JSON):**
```json
{
  "status": "success",
  "action_id": 501
}
```
* **Краткое объяснение:**
Привязывается к кнопке **"Massani o'lchash"**. Сохраняет вес в базу данных. Бэкенд сам определит, Вход это или Выход, и запишет тару или брутто. Возвращает `action_id`, который нужен для следующего шага (загрузки фото).

---

### 9. Сброс процесса (Аварийный)
* **Эндпоинт:** `POST /api/v1/process/reset`
* **Запрос:** Нет тела.
* **Ответ:** `{"status": "reset"}`
* **Краткое объяснение:**
Кнопка "Сброс" (если есть) или автоматический вызов, если машина уехала, не взвесившись. Очищает текущее состояние `weighing_service` в статус `IDLE`.

---

### 10. Журнал взвешиваний (Список)
* **Эндпоинт:** `GET /api/v1/trucks`
* **Параметры (Query):**
* `skip`: Отступ (для пагинации, по умолчанию 0).
* `limit`: Количество записей (по умолчанию 20).
* `finished`: `true` (только завершенные), `false` (те, что на территории), или не передавать (все).
* **Ответ (JSON):**
```json
[
  {
    "id": 105,
    "truck_number": "01A777AA",
    "driver_name": "Иван Иванов",
    "is_finished": true,
    "created_at": "2026-02-01T10:30:00",
    "actions": [
      { "action_type": "ENTRANCE", "weight": 10000.0, "status": "COMPLETE" },
      { "action_type": "EXIT", "weight": 25000.0, "status": "COMPLETE" }
    ]
  }
]
```
* **Краткое объяснение:**
Основной запрос для заполнения таблицы `HistoryTable`. Фронтенд должен сам посчитать Нетто (Exit - Entrance) на основе массива `actions`.

---

### 11. Детальная информация о машине
* **Эндпоинт:** `GET /api/v1/trucks/{id}`
* **Запрос:** Нет тела.
* **Ответ (JSON):**
```json
{
  "id": 105,
  "truck_number": "01A777AA",
  "model": "Kamaz",
  "owner_pinfl": "1234567890",
  "actions": [...] // Взвешивания
}
```
* **Краткое объяснение:**
Используется, когда оператор кликает на строку в таблице, чтобы посмотреть подробности или исправить данные. Также здесь можно будет добавить ссылки на фото.

---

### 12. Редактирование записи (Исправление ошибок)
* **Эндпоинт:** `PUT /api/v1/trucks/{id}`
* **Запрос (JSON):**
```json
{
  "truck_number": "01B888BB", // Если камера ошиблась
  "is_finished": true         // Принудительно завершить
}
```
* **Ответ (JSON):** Обновленный объект `TruckResponse`.
* **Краткое объяснение:**
Привязывается к кнопке "Raqamni o'zgartirish" (Изменить номер). Позволяет исправить номер машины уже после того, как она заехала.

---

### 13. Загрузка фото (Фотофиксация)
* **Эндпоинт:** `POST /api/v1/integration/camera/image`
* **Запрос (Multipart/Form-Data):**
* `file`: (binary) Сам файл изображения.
* `action_id`: (int) ID действия взвешивания (полученный из ответа `/confirm`).
* **Ответ (JSON):**
```json
{
  "id": 55,
  "url": "/api/v1/static/weighing/2026/02/01/uuid.jpg"
}
```
* **Краткое объяснение:**
Вызывается фронтендом **автоматически** сразу после успешного подтверждения веса. Фронт берет текущий кадр с видеопотока (snapshot) и отправляет его на сервер для архива.

---

### 14. Скачивание Excel отчета
* **Эндпоинт:** `GET /api/v1/reports/export/excel`
* **Параметры (Query):**
* `date_from`: `2026-02-01` (Начало периода).
* `date_to`: `2026-02-02` (Конец периода).
* **Ответ:** Бинарный файл (`.xlsx`).
* **Краткое объяснение:**
Привязывается к кнопке "Excel yuklash" в модальном окне отчетов (`ReportsModal`). Генерирует файл на лету.

---

### 15. Список продуктов (Справочник)
* **Эндпоинт:** `GET /api/v1/products`
* **Запрос:** Нет тела.
* **Ответ (JSON):**
```json
[
  { "id": 1, "name": "Ko'mir" },
  { "id": 2, "name": "Karbamid" }
]
```
* **Краткое объяснение:**
Заполняет выпадающий список (ComboBox) на панели управления. Оператор выбирает тип груза при ручном вводе или редактировании.

---

### 16. Добавление продукта
* **Эндпоинт:** `POST /api/v1/products`
* **Запрос (JSON):**
```json
{
  "name": "Yangi Mahsulot"
}
```
* **Ответ (JSON):** Созданный объект продукта с ID.
* **Краткое объяснение:**
Используется, когда в выпадающем списке выбирают пункт "Добавить...". Позволяет расширять справочник без лазания в базу данных.

---

### 17. Получение текущих настроек
* **Эндпоинт:** `GET /api/v1/settings`
* **Запрос:** Нет тела.
* **Ответ (JSON):**
```json
{
  "camera_in_ip": "192.168.1.63",
  "camera_out_ip": "192.168.1.66",
  "gate_close_timeout": 8000,
  "scale_port": "/dev/ttyUSB0"
}
```
* **Краткое объяснение:**
Используется страницей **Settings (Sozlamalar)** при загрузке. Позволяет увидеть текущую конфигурацию системы.

---

### 18. Обновление настроек
* **Эндпоинт:** `PUT /api/v1/settings`
* **Запрос (JSON):**
```json
{
  "gate_close_timeout": 10000, // Увеличили время
  "camera_in_ip": "192.168.1.64"
}
```
* **Ответ:** `{"status": "updated"}`
* **Краткое объяснение:**
Сохраняет новые настройки. Бэкенд должен применить их сразу (например, переподключиться к камере) или при перезагрузке.

---

### 19. Смена пароля пользователя
* **Эндпоинт:** `POST /api/v1/users/change-password`
* **Запрос (JSON):**
```json
{
  "old_password": "current_password",
  "new_password": "new_secure_password"
}
```
* **Ответ:** `{"status": "success"}`
* **Краткое объяснение:**
Используется на странице **Profile (Ma'lumotlarim)**. Позволяет оператору сменить свой пароль. Требует `Authorization` заголовок.

---

### 20. Создание нового пользователя (Админ)
* **Эндпоинт:** `POST /api/v1/users`
* **Запрос (JSON):**
```json
{
  "phone_number": "+998901234567",
  "password": "secret_password"
}
```
* **Ответ:** Данные созданного пользователя.
* **Краткое объяснение:**
Нужен для добавления новых сотрудников. Обычно доступен только супер-администратору.

---

### 21. Сводная статистика (Dashboard)
* **Эндпоинт:** `GET /api/v1/reports/summary`
* **Параметры:** `?date_from=...&date_to=...`
* **Ответ (JSON):**
```json
{
  "total_trucks": 45,
  "total_weight_in": 120500.0,
  "total_weight_out": 85000.0
}
```
* **Краткое объяснение:**
Может использоваться для отображения карточек со статистикой за день на главной панели (если будет такой дизайн).

---

### 22. Удаление записи (Корзина)
* **Эндпоинт:** `DELETE /api/v1/trucks/{id}`
* **Запрос:** Нет тела.
* **Ответ:** `{"status": "deleted"}`
* **Краткое объяснение:**
Привязывается к красной кнопке с иконкой мусорки (visible only for active/unfinished trucks) на панели управления. Помечает запись как `is_deleted = true`.

---

### 23. Прокси для снимка с камеры
* **Эндпоинт:** `GET /api/v1/hardware/cameras/snapshot/{camera_id}`
* **Параметры:** `camera_id` (1 или 2).
* **Ответ:** Бинарные данные (изображение JPEG).
* **Краткое объяснение:**
Позволяет фронтенду получить картинку с камеры, даже если камера находится в другой подсети, недоступной для браузера клиента. Бэкенд скачивает кадр по RTSP/HTTP и отдает его фронту. Используется в квадратах "Камера" на дашборде.
---
